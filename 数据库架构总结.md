# 数据库架构总结

## 📊 概述

本文档提供说唱专辑论坛项目数据库架构的完整总结，包括表结构、关系、索引和关键功能。

## 🗄️ 数据表详情

### 1. users (用户表)

**用途**: 存储用户的扩展信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 用户ID |
| auth_id | UUID | FK → auth.users | 关联Supabase Auth |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名（3字符以上） |
| email | VARCHAR(255) | UNIQUE, NOT NULL | 邮箱 |
| avatar | TEXT | NULL | 头像URL |
| bio | TEXT | NULL | 个人简介 |
| role | VARCHAR(20) | DEFAULT 'user' | 角色: user/admin |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |

**索引**:
- `idx_users_auth_id` - auth_id
- `idx_users_username` - username
- `idx_users_email` - email
- `idx_users_created_at` - created_at DESC

**关系**:
- → album_ratings, album_comments, posts, post_replies, favorites, notifications

---

### 2. albums (专辑表)

**用途**: 存储说唱专辑信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 专辑ID |
| title | VARCHAR(255) | NOT NULL | 专辑标题 |
| artist | VARCHAR(255) | NOT NULL | 艺人名称 |
| cover_url | TEXT | NOT NULL | 封面URL |
| release_date | DATE | NOT NULL | 发行日期 |
| genre | VARCHAR(100) | NOT NULL | 音乐流派 |
| description | TEXT | NULL | 专辑介绍 |
| artist_bio | TEXT | NULL | 艺人简介 |
| rating | DECIMAL(3,2) | DEFAULT 0, 0-5 | 平均评分 |
| rating_count | INTEGER | DEFAULT 0 | 评分人数 |
| song_count | INTEGER | DEFAULT 0 | 歌曲数量 |
| preview_url | TEXT | NULL | 预览音频URL |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |

**索引**:
- `idx_albums_artist` - artist
- `idx_albums_genre` - genre
- `idx_albums_release_date` - release_date DESC
- `idx_albums_rating` - rating DESC
- `idx_albums_title` - GIN全文索引
- `idx_albums_created_at` - created_at DESC

**关系**:
- → songs, album_ratings, album_comments, favorites, posts.related_album_id

**自动更新**:
- `rating` 和 `rating_count` 由触发器自动计算
- `song_count` 由触发器自动更新

---

### 3. songs (歌曲表)

**用途**: 存储专辑中的歌曲信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 歌曲ID |
| album_id | UUID | FK → albums, NOT NULL | 所属专辑 |
| title | VARCHAR(255) | NOT NULL | 歌曲标题 |
| track_number | INTEGER | NOT NULL, >0 | 曲目编号 |
| duration | INTEGER | NOT NULL, >0 | 时长（秒） |
| audio_url | TEXT | NOT NULL | 音频URL |
| lyrics | TEXT | NULL | 歌词 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |

**约束**:
- UNIQUE(album_id, track_number) - 每个专辑的曲目编号唯一

**索引**:
- `idx_songs_album_id` - album_id
- `idx_songs_track_number` - (album_id, track_number)
- `idx_songs_title` - GIN全文索引

**关系**:
- ← albums (多对一)

---

### 4. album_ratings (专辑评分表)

**用途**: 用户对专辑的评分

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 评分ID |
| user_id | UUID | FK → users, NOT NULL | 用户 |
| album_id | UUID | FK → albums, NOT NULL | 专辑 |
| score | INTEGER | NOT NULL, 1-5 | 评分（星级） |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |

**约束**:
- UNIQUE(user_id, album_id) - 每个用户对每个专辑只能评一次分

**索引**:
- `idx_album_ratings_user_id` - user_id
- `idx_album_ratings_album_id` - album_id
- `idx_album_ratings_score` - score
- `idx_album_ratings_created_at` - created_at DESC

**触发器**:
- 插入/更新/删除时自动更新 albums 表的 rating 和 rating_count

---

### 5. album_comments (专辑评论表)

**用途**: 用户对专辑的评论和回复

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 评论ID |
| user_id | UUID | FK → users, NOT NULL | 用户 |
| album_id | UUID | FK → albums, NOT NULL | 专辑 |
| content | TEXT | NOT NULL | 评论内容 |
| parent_id | UUID | FK → album_comments | 父评论ID |
| likes | INTEGER | DEFAULT 0 | 点赞数 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |

**索引**:
- `idx_album_comments_user_id` - user_id
- `idx_album_comments_album_id` - album_id
- `idx_album_comments_parent_id` - parent_id
- `idx_album_comments_created_at` - created_at DESC
- `idx_album_comments_likes` - likes DESC

**特性**:
- 支持嵌套评论（楼中楼）
- parent_id 为 NULL 表示顶级评论

---

### 6. forum_categories (论坛版块表)

**用途**: 论坛的分类版块

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 版块ID |
| name | VARCHAR(100) | UNIQUE, NOT NULL | 版块名称 |
| description | TEXT | NULL | 版块描述 |
| icon | TEXT | NULL | 版块图标 |
| sort_order | INTEGER | DEFAULT 0 | 排序顺序 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |

**索引**:
- `idx_forum_categories_sort_order` - sort_order

**预设数据**:
1. 专辑讨论 🎵
2. 歌曲故事 📖
3. 说唱文化 🎤
4. 新人推荐 ⭐
5. 站务公告 📢

---

### 7. posts (帖子表)

**用途**: 论坛帖子

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 帖子ID |
| user_id | UUID | FK → users, NOT NULL | 发帖用户 |
| category_id | UUID | FK → forum_categories | 所属版块 |
| title | VARCHAR(255) | NOT NULL | 帖子标题 |
| content | TEXT | NOT NULL | 帖子内容 |
| related_album_id | UUID | FK → albums | 关联专辑 |
| reply_count | INTEGER | DEFAULT 0 | 回复数量 |
| likes | INTEGER | DEFAULT 0 | 点赞数 |
| is_pinned | BOOLEAN | DEFAULT FALSE | 是否置顶 |
| is_highlighted | BOOLEAN | DEFAULT FALSE | 是否精华 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |

**索引**:
- `idx_posts_user_id` - user_id
- `idx_posts_category_id` - category_id
- `idx_posts_related_album_id` - related_album_id
- `idx_posts_created_at` - created_at DESC
- `idx_posts_is_pinned` - (is_pinned, created_at DESC)
- `idx_posts_is_highlighted` - (is_highlighted, created_at DESC)
- `idx_posts_title` - GIN全文索引
- `idx_posts_content` - GIN全文索引

**自动更新**:
- `reply_count` 由触发器自动更新

---

### 8. post_replies (帖子回复表)

**用途**: 对帖子的回复

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 回复ID |
| post_id | UUID | FK → posts, NOT NULL | 所属帖子 |
| user_id | UUID | FK → users, NOT NULL | 回复用户 |
| content | TEXT | NOT NULL | 回复内容 |
| parent_id | UUID | FK → post_replies | 父回复ID |
| likes | INTEGER | DEFAULT 0 | 点赞数 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |

**索引**:
- `idx_post_replies_post_id` - post_id
- `idx_post_replies_user_id` - user_id
- `idx_post_replies_parent_id` - parent_id
- `idx_post_replies_created_at` - created_at DESC
- `idx_post_replies_likes` - likes DESC

**特性**:
- 支持楼中楼回复
- 触发器自动更新帖子的回复数

---

### 9. favorites (收藏表)

**用途**: 用户收藏的专辑

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 收藏ID |
| user_id | UUID | FK → users, NOT NULL | 用户 |
| album_id | UUID | FK → albums, NOT NULL | 专辑 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 收藏时间 |

**约束**:
- UNIQUE(user_id, album_id) - 每个用户对每个专辑只能收藏一次

**索引**:
- `idx_favorites_user_id` - user_id
- `idx_favorites_album_id` - album_id
- `idx_favorites_created_at` - created_at DESC

---

### 10. notifications (通知表)

**用途**: 用户的消息通知

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK | 通知ID |
| user_id | UUID | FK → users, NOT NULL | 接收用户 |
| type | VARCHAR(20) | NOT NULL | 通知类型 |
| title | VARCHAR(255) | NOT NULL | 通知标题 |
| content | TEXT | NOT NULL | 通知内容 |
| link | TEXT | NULL | 相关链接 |
| is_read | BOOLEAN | DEFAULT FALSE | 是否已读 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |

**通知类型**:
- `reply` - 回复通知
- `like` - 点赞通知
- `system` - 系统通知

**索引**:
- `idx_notifications_user_id` - user_id
- `idx_notifications_is_read` - (user_id, is_read)
- `idx_notifications_created_at` - created_at DESC
- `idx_notifications_type` - type

---

## 🔍 视图 (Views)

### 1. album_details

**用途**: 专辑详细信息，包含实际歌曲数和收藏数

```sql
SELECT 
    a.*,
    COUNT(DISTINCT s.id) as actual_song_count,
    COUNT(DISTINCT f.id) as favorite_count
FROM albums a
LEFT JOIN songs s ON a.id = s.album_id
LEFT JOIN favorites f ON a.id = f.album_id
GROUP BY a.id
```

### 2. post_details

**用途**: 帖子详细信息，包含用户、版块和关联专辑信息

```sql
SELECT 
    p.*,
    u.username,
    u.avatar as user_avatar,
    fc.name as category_name,
    a.title as related_album_title,
    a.artist as related_album_artist
FROM posts p
LEFT JOIN users u ON p.user_id = u.id
LEFT JOIN forum_categories fc ON p.category_id = fc.id
LEFT JOIN albums a ON p.related_album_id = a.id
```

### 3. album_comment_details

**用途**: 专辑评论详细信息，包含用户信息

```sql
SELECT 
    ac.*,
    u.username,
    u.avatar as user_avatar
FROM album_comments ac
LEFT JOIN users u ON ac.user_id = u.id
```

---

## ⚡ 触发器 (Triggers)

### 1. 自动更新 updated_at

**应用表**: users, albums, songs, album_ratings, album_comments, forum_categories, posts, post_replies

**功能**: 任何更新操作都会自动设置 `updated_at = NOW()`

### 2. 更新专辑评分

**触发表**: album_ratings

**功能**: 
- INSERT/UPDATE/DELETE 时自动重新计算专辑的平均分和评分人数
- 更新 albums 表的 `rating` 和 `rating_count` 字段

### 3. 更新帖子回复数

**触发表**: post_replies

**功能**:
- INSERT/DELETE 时自动更新帖子的回复数
- 更新 posts 表的 `reply_count` 字段

### 4. 更新专辑歌曲数

**触发表**: songs

**功能**:
- INSERT/DELETE 时自动更新专辑的歌曲数
- 更新 albums 表的 `song_count` 字段

---

## 🔒 Row Level Security (RLS)

所有表都启用了 RLS，权限策略如下：

### 公开可读表
- albums
- songs
- album_ratings
- album_comments
- forum_categories
- posts
- post_replies

### 用户私有表
- favorites (只能查看和操作自己的收藏)
- notifications (只能查看和更新自己的通知)

### 用户可管理自己的内容
- album_ratings (CRUD自己的评分)
- album_comments (CRUD自己的评论)
- posts (CRUD自己的帖子)
- post_replies (CRUD自己的回复)
- users (更新自己的信息)

### 管理员权限
- albums (完全管理)
- songs (完全管理)
- forum_categories (完全管理)
- posts (可以删除任何帖子)
- album_comments (可以删除任何评论)
- post_replies (可以删除任何回复)

---

## 🛠️ 自定义函数

### 1. search_albums

**功能**: 搜索和筛选专辑

**参数**:
- `search_query` TEXT - 搜索关键词
- `genre_filter` TEXT - 流派筛选
- `year_filter` INTEGER - 年份筛选
- `sort_by` TEXT - 排序方式 (releaseDate/rating/popular)
- `page_num` INTEGER - 页码
- `page_size` INTEGER - 每页数量

**返回**: 专辑列表和总数

### 2. get_user_stats

**功能**: 获取用户的统计信息

**参数**:
- `target_user_id` UUID - 目标用户ID

**返回**:
- `post_count` - 发帖数
- `reply_count` - 回复数
- `comment_count` - 评论数
- `favorite_count` - 收藏数
- `rating_count` - 评分数

---

## 📈 数据流图

### 用户评分专辑流程
```
用户操作 → album_ratings 表
    ↓
触发器: update_album_rating
    ↓
更新 albums 表的 rating 和 rating_count
```

### 用户发帖流程
```
用户操作 → posts 表
    ↓
其他用户回复 → post_replies 表
    ↓
触发器: update_post_reply_count
    ↓
更新 posts 表的 reply_count
```

### 添加歌曲流程
```
管理员操作 → songs 表
    ↓
触发器: update_album_song_count
    ↓
更新 albums 表的 song_count
```

---

## 📊 性能优化

### 索引策略
1. **主键索引**: 所有表都有 UUID 主键
2. **外键索引**: 所有外键字段都有索引
3. **查询索引**: 常用查询字段（如 created_at, rating, likes）都有索引
4. **全文搜索索引**: albums.title, songs.title, posts.title, posts.content 都有 GIN 索引
5. **复合索引**: 常见的组合查询（如 is_pinned + created_at）有复合索引

### 查询优化
1. 使用视图预先 JOIN 常用的关联数据
2. 触发器自动维护聚合字段，避免实时计算
3. RLS 策略使用高效的子查询
4. 分页查询使用 LIMIT 和 OFFSET

---

## 🔄 数据同步和一致性

### 级联删除
- 删除用户 → 级联删除其所有数据
- 删除专辑 → 级联删除其歌曲、评分、评论、收藏
- 删除帖子 → 级联删除其回复
- 删除评论/回复 → 级联删除其子评论/子回复

### 约束检查
- CHECK 约束确保数据范围有效（如评分1-5星）
- UNIQUE 约束防止重复（如用户名、邮箱）
- NOT NULL 约束确保必填字段
- 外键约束确保引用完整性

---

## 📝 使用建议

### 开发阶段
1. 使用 `supabase_test_data.sql` 插入测试数据
2. 在开发环境使用独立的 Supabase 项目
3. 频繁备份数据库

### 生产环境
1. 定期备份数据库
2. 监控数据库性能
3. 根据实际使用情况调整索引
4. 定期清理过期数据（如已读通知）
5. 监控 RLS 策略的性能影响

### 扩展建议
1. 考虑添加缓存层（Redis）减轻数据库压力
2. 对热门数据进行预加载
3. 实现数据分页和懒加载
4. 使用 CDN 加速静态资源（封面图、音频文件）

---

**文档版本**: 1.0  
**最后更新**: 2025-10-21  
**维护者**: AI进化论-花生

