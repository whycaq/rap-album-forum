# Supabase æ•°æ®åº“é…ç½®æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ åœ¨ Supabase ä¸Šåˆ›å»ºè¯´å”±ä¸“è¾‘è®ºå›ç½‘ç«™æ‰€éœ€çš„æ•°æ®åº“è¡¨ã€‚

## ğŸ¯ æ•°æ®åº“æ¶æ„è¯´æ˜

### æ•°æ®è¡¨ç»“æ„

é¡¹ç›®åŒ…å«ä»¥ä¸‹10ä¸ªæ ¸å¿ƒæ•°æ®è¡¨ï¼š

1. **users** - ç”¨æˆ·ä¿¡æ¯è¡¨
   - å­˜å‚¨ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼ˆç”¨æˆ·åã€é‚®ç®±ã€å¤´åƒã€ç®€ä»‹ç­‰ï¼‰
   - å…³è”åˆ° Supabase Auth çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

2. **albums** - ä¸“è¾‘è¡¨
   - å­˜å‚¨è¯´å”±ä¸“è¾‘çš„è¯¦ç»†ä¿¡æ¯
   - åŒ…å«å°é¢ã€è‰ºäººã€å‘è¡Œæ—¥æœŸã€è¯„åˆ†ç­‰

3. **songs** - æ­Œæ›²è¡¨
   - å­˜å‚¨ä¸“è¾‘ä¸­çš„æ­Œæ›²ä¿¡æ¯
   - åŒ…å«æ­Œæ›²æ ‡é¢˜ã€æ—¶é•¿ã€è¯•å¬é“¾æ¥ã€æ­Œè¯ç­‰

4. **album_ratings** - ä¸“è¾‘è¯„åˆ†è¡¨
   - ç”¨æˆ·å¯¹ä¸“è¾‘çš„è¯„åˆ†ï¼ˆ1-5æ˜Ÿï¼‰
   - æ¯ä¸ªç”¨æˆ·å¯¹æ¯ä¸ªä¸“è¾‘åªèƒ½è¯„ä¸€æ¬¡åˆ†

5. **album_comments** - ä¸“è¾‘è¯„è®ºè¡¨
   - ç”¨æˆ·å¯¹ä¸“è¾‘çš„è¯„è®º
   - æ”¯æŒåµŒå¥—å›å¤ï¼ˆæ¥¼ä¸­æ¥¼ï¼‰

6. **forum_categories** - è®ºå›ç‰ˆå—è¡¨
   - è®ºå›çš„åˆ†ç±»ç‰ˆå—
   - å·²é¢„è®¾5ä¸ªç‰ˆå—ï¼ˆä¸“è¾‘è®¨è®ºã€æ­Œæ›²æ•…äº‹ã€è¯´å”±æ–‡åŒ–ã€æ–°äººæ¨èã€ç«™åŠ¡å…¬å‘Šï¼‰

7. **posts** - å¸–å­è¡¨
   - è®ºå›å¸–å­
   - æ”¯æŒå…³è”ä¸“è¾‘ã€ç½®é¡¶ã€ç²¾åç­‰åŠŸèƒ½

8. **post_replies** - å¸–å­å›å¤è¡¨
   - å¯¹å¸–å­çš„å›å¤
   - æ”¯æŒæ¥¼ä¸­æ¥¼å›å¤

9. **favorites** - æ”¶è—è¡¨
   - ç”¨æˆ·æ”¶è—çš„ä¸“è¾‘

10. **notifications** - é€šçŸ¥è¡¨
    - ç”¨æˆ·çš„æ¶ˆæ¯é€šçŸ¥ï¼ˆå›å¤ã€ç‚¹èµã€ç³»ç»Ÿé€šçŸ¥ï¼‰

### æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

âœ… **è‡ªåŠ¨è§¦å‘å™¨**
- è‡ªåŠ¨æ›´æ–° `updated_at` æ—¶é—´æˆ³
- è‡ªåŠ¨è®¡ç®—ä¸“è¾‘å¹³å‡è¯„åˆ†å’Œè¯„åˆ†äººæ•°
- è‡ªåŠ¨æ›´æ–°å¸–å­å›å¤æ•°é‡
- è‡ªåŠ¨æ›´æ–°ä¸“è¾‘æ­Œæ›²æ•°é‡

âœ… **Row Level Security (RLS)**
- å®Œæ•´çš„æƒé™æ§åˆ¶ç­–ç•¥
- ç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„æ•°æ®
- ç®¡ç†å‘˜æ‹¥æœ‰æ›´å¤šæƒé™
- ä¿æŠ¤éšç§æ•°æ®ï¼ˆæ”¶è—ã€é€šçŸ¥ç­‰ï¼‰

âœ… **æ€§èƒ½ä¼˜åŒ–**
- æ‰€æœ‰è¡¨éƒ½æœ‰åˆç†çš„ç´¢å¼•
- æ”¯æŒå…¨æ–‡æœç´¢ï¼ˆä¸“è¾‘ã€æ­Œæ›²ã€å¸–å­ï¼‰
- ä¼˜åŒ–çš„æŸ¥è¯¢è§†å›¾

âœ… **æ•°æ®å®Œæ•´æ€§**
- å¤–é”®çº¦æŸç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- CHECK çº¦æŸéªŒè¯æ•°æ®æœ‰æ•ˆæ€§
- UNIQUE çº¦æŸé˜²æ­¢é‡å¤æ•°æ®

## ğŸš€ é…ç½®æ­¥éª¤

### æ­¥éª¤ 1: åˆ›å»º Supabase é¡¹ç›®

1. è®¿é—® [Supabase](https://supabase.com/) å¹¶ç™»å½•
2. ç‚¹å‡» "New Project" åˆ›å»ºæ–°é¡¹ç›®
3. å¡«å†™é¡¹ç›®ä¿¡æ¯ï¼š
   - **Name**: `rap-album-forum`ï¼ˆæˆ–ä½ å–œæ¬¢çš„åå­—ï¼‰
   - **Database Password**: è®¾ç½®ä¸€ä¸ªå¼ºå¯†ç ï¼ˆè¯·å¦¥å–„ä¿å­˜ï¼‰
   - **Region**: é€‰æ‹©ç¦»ä½ æœ€è¿‘çš„åŒºåŸŸï¼ˆå»ºè®®é€‰æ‹© `Northeast Asia (Tokyo)` æˆ– `Southeast Asia (Singapore)`ï¼‰
4. ç‚¹å‡» "Create new project" å¹¶ç­‰å¾…é¡¹ç›®åˆ›å»ºå®Œæˆï¼ˆçº¦2åˆ†é’Ÿï¼‰

### æ­¥éª¤ 2: æ‰§è¡Œ SQL è„šæœ¬

1. åœ¨ Supabase æ§åˆ¶å°å·¦ä¾§èœå•ï¼Œç‚¹å‡» "SQL Editor"
2. ç‚¹å‡» "New Query" åˆ›å»ºæ–°æŸ¥è¯¢
3. æ‰“å¼€é¡¹ç›®æ ¹ç›®å½•çš„ `supabase_schema.sql` æ–‡ä»¶
4. å¤åˆ¶å…¨éƒ¨å†…å®¹
5. ç²˜è´´åˆ° Supabase SQL Editor ä¸­
6. ç‚¹å‡» "Run" æŒ‰é’®æ‰§è¡Œè„šæœ¬
7. ç­‰å¾…æ‰§è¡Œå®Œæˆï¼Œåº”è¯¥çœ‹åˆ°æˆåŠŸæç¤º

> âš ï¸ **æ³¨æ„**: è„šæœ¬æ‰§è¡Œå¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚å¦‚æœå‡ºç°é”™è¯¯ï¼Œè¯·æŸ¥çœ‹é”™è¯¯ä¿¡æ¯å¹¶è”ç³»æŠ€æœ¯æ”¯æŒã€‚

### æ­¥éª¤ 3: éªŒè¯è¡¨åˆ›å»º

1. åœ¨å·¦ä¾§èœå•ç‚¹å‡» "Table Editor"
2. åº”è¯¥èƒ½çœ‹åˆ°ä»¥ä¸‹10ä¸ªè¡¨ï¼š
   - âœ… users
   - âœ… albums
   - âœ… songs
   - âœ… album_ratings
   - âœ… album_comments
   - âœ… forum_categories
   - âœ… posts
   - âœ… post_replies
   - âœ… favorites
   - âœ… notifications

3. ç‚¹å‡»ä»»æ„è¡¨ï¼Œå¯ä»¥æŸ¥çœ‹è¡¨ç»“æ„å’Œæ•°æ®

### æ­¥éª¤ 4: æ£€æŸ¥åˆå§‹æ•°æ®

1. åœ¨ "Table Editor" ä¸­ç‚¹å‡» `forum_categories` è¡¨
2. åº”è¯¥èƒ½çœ‹åˆ°5æ¡é¢„è®¾çš„è®ºå›ç‰ˆå—æ•°æ®ï¼š
   - ä¸“è¾‘è®¨è®º ğŸµ
   - æ­Œæ›²æ•…äº‹ ğŸ“–
   - è¯´å”±æ–‡åŒ– ğŸ¤
   - æ–°äººæ¨è â­
   - ç«™åŠ¡å…¬å‘Š ğŸ“¢

### æ­¥éª¤ 5: è·å– API å‡­è¯

1. åœ¨å·¦ä¾§èœå•ç‚¹å‡» "Project Settings" â†’ "API"
2. è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
   - **Project URL**: ä½ çš„é¡¹ç›®APIåœ°å€
   - **anon public key**: å…¬å¼€APIå¯†é’¥
   - **service_role key**: æœåŠ¡ç«¯APIå¯†é’¥ï¼ˆè¯·å¦¥å–„ä¿å­˜ï¼Œä¸è¦æ³„éœ²ï¼‰

### æ­¥éª¤ 6: é…ç½®é¡¹ç›®ç¯å¢ƒå˜é‡

1. åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ï¼š

```bash
# Supabase é…ç½®
VITE_SUPABASE_URL=ä½ çš„é¡¹ç›®URL
VITE_SUPABASE_ANON_KEY=ä½ çš„anon_public_key

# API Base URL
VITE_API_BASE_URL=ä½ çš„é¡¹ç›®URL
```

2. å°†æ­¥éª¤5ä¸­è·å–çš„ä¿¡æ¯å¡«å…¥ç›¸åº”ä½ç½®

### æ­¥éª¤ 7: é…ç½®è®¤è¯è®¾ç½®

1. åœ¨å·¦ä¾§èœå•ç‚¹å‡» "Authentication" â†’ "Providers"
2. é…ç½®é‚®ç®±è®¤è¯ï¼ˆé»˜è®¤å·²å¯ç”¨ï¼‰
3. å¯é€‰ï¼šé…ç½®ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆGoogle, GitHubç­‰ï¼‰

## ğŸ“Š æ•°æ®å…³ç³»å›¾

```
users (ç”¨æˆ·)
  â”œâ”€â†’ album_ratings (è¯„åˆ†)
  â”œâ”€â†’ album_comments (è¯„è®º)
  â”œâ”€â†’ posts (å¸–å­)
  â”œâ”€â†’ post_replies (å›å¤)
  â”œâ”€â†’ favorites (æ”¶è—)
  â””â”€â†’ notifications (é€šçŸ¥)

albums (ä¸“è¾‘)
  â”œâ”€â†’ songs (æ­Œæ›²)
  â”œâ”€â†’ album_ratings (è¯„åˆ†)
  â”œâ”€â†’ album_comments (è¯„è®º)
  â”œâ”€â†’ favorites (æ”¶è—)
  â””â”€â†’ posts.related_album_id (å…³è”å¸–å­)

forum_categories (ç‰ˆå—)
  â””â”€â†’ posts (å¸–å­)

posts (å¸–å­)
  â””â”€â†’ post_replies (å›å¤)

album_comments (è¯„è®º)
  â””â”€â†’ album_comments.parent_id (å­è¯„è®º)

post_replies (å›å¤)
  â””â”€â†’ post_replies.parent_id (å­å›å¤)
```

## ğŸ” æƒé™è¯´æ˜

### æ™®é€šç”¨æˆ·æƒé™

- âœ… æŸ¥çœ‹æ‰€æœ‰å…¬å¼€å†…å®¹ï¼ˆä¸“è¾‘ã€æ­Œæ›²ã€å¸–å­ã€è¯„è®ºï¼‰
- âœ… å‘è¡¨è¯„è®ºå’Œå›å¤
- âœ… å¯¹ä¸“è¾‘è¯„åˆ†
- âœ… æ”¶è—ä¸“è¾‘
- âœ… å‘å¸ƒå’Œç®¡ç†è‡ªå·±çš„å¸–å­
- âœ… ä¿®æ”¹è‡ªå·±çš„ä¸ªäººä¿¡æ¯
- âœ… æŸ¥çœ‹å’Œç®¡ç†è‡ªå·±çš„é€šçŸ¥
- âŒ ä¸èƒ½ä¿®æ”¹åˆ«äººçš„å†…å®¹
- âŒ ä¸èƒ½ç®¡ç†ä¸“è¾‘å’Œæ­Œæ›²

### ç®¡ç†å‘˜æƒé™

- âœ… æ‰€æœ‰æ™®é€šç”¨æˆ·æƒé™
- âœ… æ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤ä¸“è¾‘å’Œæ­Œæ›²
- âœ… ç®¡ç†è®ºå›ç‰ˆå—
- âœ… åˆ é™¤ä»»ä½•ä¸å½“å†…å®¹ï¼ˆè¯„è®ºã€å¸–å­ã€å›å¤ï¼‰
- âœ… ç½®é¡¶å’ŒåŠ ç²¾å¸–å­
- âœ… ç®¡ç†ç”¨æˆ·ï¼ˆç¦ç”¨ã€è§£ç¦ç­‰ï¼‰

## ğŸ› ï¸ å¸¸ç”¨ SQL æŸ¥è¯¢

### è·å–çƒ­é—¨ä¸“è¾‘ï¼ˆæŒ‰è¯„åˆ†ï¼‰

```sql
SELECT * FROM albums 
WHERE rating_count >= 10 
ORDER BY rating DESC, rating_count DESC 
LIMIT 10;
```

### è·å–æœ€æ–°å‘å¸ƒçš„ä¸“è¾‘

```sql
SELECT * FROM albums 
ORDER BY release_date DESC 
LIMIT 20;
```

### è·å–ç”¨æˆ·çš„æ‰€æœ‰æ”¶è—

```sql
SELECT a.* 
FROM favorites f
JOIN albums a ON f.album_id = a.id
WHERE f.user_id = 'ç”¨æˆ·ID'
ORDER BY f.created_at DESC;
```

### è·å–å¸–å­åŠå…¶å›å¤æ•°

```sql
SELECT p.*, u.username, u.avatar as user_avatar, fc.name as category_name
FROM posts p
JOIN users u ON p.user_id = u.id
JOIN forum_categories fc ON p.category_id = fc.id
ORDER BY p.created_at DESC;
```

### æœç´¢ä¸“è¾‘ï¼ˆä½¿ç”¨å‡½æ•°ï¼‰

```sql
SELECT * FROM search_albums(
    search_query := 'ä¸“è¾‘åæˆ–è‰ºäººå',
    genre_filter := NULL,
    year_filter := 2023,
    sort_by := 'rating',
    page_num := 1,
    page_size := 20
);
```

## ğŸ§ª æµ‹è¯•æ•°æ®

### åˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼ˆé€šè¿‡ Supabase Authï¼‰

åœ¨ Supabase Dashboard:
1. ç‚¹å‡» "Authentication" â†’ "Users"
2. ç‚¹å‡» "Add user" â†’ "Create new user"
3. å¡«å†™é‚®ç®±å’Œå¯†ç 
4. ç”¨æˆ·åˆ›å»ºåï¼Œéœ€è¦åœ¨ `public.users` è¡¨ä¸­æ·»åŠ å¯¹åº”è®°å½•

### æ’å…¥æµ‹è¯•ä¸“è¾‘

```sql
-- æ’å…¥æµ‹è¯•ä¸“è¾‘
INSERT INTO public.albums (title, artist, cover_url, release_date, genre, description, rating, rating_count) VALUES
('The Eminem Show', 'Eminem', 'https://example.com/eminem-show.jpg', '2002-05-26', 'Hip Hop', 'Eminemçš„ç»å…¸ä¸“è¾‘', 4.8, 1250),
('Illmatic', 'Nas', 'https://example.com/illmatic.jpg', '1994-04-19', 'Hip Hop', 'Nasçš„é¦–å¼ ä¸“è¾‘ï¼Œè¢«èª‰ä¸ºå˜»å“ˆå²ä¸Šæœ€ä¼Ÿå¤§çš„ä¸“è¾‘ä¹‹ä¸€', 4.9, 2100),
('ä¸­å›½æ–°è¯´å”±', 'Various Artists', 'https://example.com/rap-china.jpg', '2023-08-15', 'Chinese Hip Hop', 'ä¸­å›½è¯´å”±éŸ³ä¹åˆè¾‘', 4.3, 850);
```

### æ’å…¥æµ‹è¯•æ­Œæ›²

```sql
-- è·å–åˆšæ’å…¥çš„ä¸“è¾‘ID
-- å‡è®¾ Eminem Show çš„ ID æ˜¯ 'album-id-1'

INSERT INTO public.songs (album_id, title, track_number, duration, audio_url) VALUES
('album-id-1', 'Without Me', 1, 290, 'https://example.com/without-me.mp3'),
('album-id-1', 'Cleanin Out My Closet', 2, 297, 'https://example.com/cleaning.mp3'),
('album-id-1', 'Superman', 3, 350, 'https://example.com/superman.mp3');
```

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1: SQLè„šæœ¬æ‰§è¡Œå¤±è´¥

**å¯èƒ½åŸå› **: 
- æ•°æ®åº“æ‰©å±•æœªå¯ç”¨
- æƒé™ä¸è¶³
- SQLè¯­æ³•é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®ä¿ä»¥è¶…çº§ç®¡ç†å‘˜èº«ä»½æ‰§è¡Œè„šæœ¬
2. æ£€æŸ¥é”™è¯¯ä¿¡æ¯ï¼Œå®šä½é—®é¢˜æ‰€åœ¨è¡Œ
3. å°è¯•åˆ†æ®µæ‰§è¡Œï¼ˆå…ˆåˆ›å»ºè¡¨ï¼Œå†åˆ›å»ºè§¦å‘å™¨ï¼Œæœ€ååˆ›å»ºRLSç­–ç•¥ï¼‰

### é—®é¢˜2: RLSç­–ç•¥é˜»æ­¢äº†æ•°æ®è®¿é—®

**å¯èƒ½åŸå› **: 
- ç”¨æˆ·æœªç™»å½•
- `public.users` è¡¨ä¸­æ²¡æœ‰å¯¹åº”çš„ç”¨æˆ·è®°å½•
- auth.uid() æ— æ³•æ­£ç¡®è¯†åˆ«

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®ä¿ç”¨æˆ·å·²é€šè¿‡ Supabase Auth ç™»å½•
2. åœ¨ `public.users` è¡¨ä¸­åˆ›å»ºå¯¹åº”çš„ç”¨æˆ·è®°å½•ï¼Œå¹¶æ­£ç¡®è®¾ç½® `auth_id` å­—æ®µ
3. æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®

### é—®é¢˜3: è§¦å‘å™¨æœªç”Ÿæ•ˆ

**å¯èƒ½åŸå› **: 
- è§¦å‘å™¨åˆ›å»ºå¤±è´¥
- è§¦å‘å™¨è¢«ç¦ç”¨

**è§£å†³æ–¹æ¡ˆ**:
1. åœ¨ SQL Editor ä¸­æ‰§è¡Œ: `SELECT * FROM pg_trigger;` æŸ¥çœ‹æ‰€æœ‰è§¦å‘å™¨
2. é‡æ–°æ‰§è¡Œè§¦å‘å™¨åˆ›å»ºè¯­å¥
3. æ£€æŸ¥è§¦å‘å™¨å‡½æ•°æ˜¯å¦æ­£ç¡®

### é—®é¢˜4: æ— æ³•è¿æ¥åˆ°æ•°æ®åº“

**å¯èƒ½åŸå› **: 
- ç½‘ç»œé—®é¢˜
- APIå¯†é’¥é”™è¯¯
- é¡¹ç›®æš‚åœ

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. éªŒè¯ `.env` æ–‡ä»¶ä¸­çš„é…ç½®æ˜¯å¦æ­£ç¡®
3. åœ¨ Supabase Dashboard æ£€æŸ¥é¡¹ç›®çŠ¶æ€

## ğŸ“š ç›¸å…³èµ„æº

- [Supabase å®˜æ–¹æ–‡æ¡£](https://supabase.com/docs)
- [PostgreSQL æ–‡æ¡£](https://www.postgresql.org/docs/)
- [Row Level Security æŒ‡å—](https://supabase.com/docs/guides/auth/row-level-security)
- [Supabase JavaScript å®¢æˆ·ç«¯](https://supabase.com/docs/reference/javascript)

## ğŸ¯ ä¸‹ä¸€æ­¥

æ•°æ®åº“é…ç½®å®Œæˆåï¼Œä½ å¯ä»¥ï¼š

1. âœ… å®‰è£… Supabase JavaScript å®¢æˆ·ç«¯
   ```bash
   npm install @supabase/supabase-js
   ```

2. âœ… åœ¨é¡¹ç›®ä¸­åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
   ```typescript
   // src/utils/supabase.ts
   import { createClient } from '@supabase/supabase-js'
   
   const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
   const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY
   
   export const supabase = createClient(supabaseUrl, supabaseAnonKey)
   ```

3. âœ… ä¿®æ”¹ API å±‚ï¼Œä½¿ç”¨ Supabase æ›¿ä»£åŸæœ‰çš„ Mock æ•°æ®

4. âœ… å®ç°ç”¨æˆ·è®¤è¯åŠŸèƒ½

5. âœ… å¼€å§‹å¼€å‘å…·ä½“çš„ä¸šåŠ¡åŠŸèƒ½

## ğŸ’¡ æç¤º

- å®šæœŸå¤‡ä»½æ•°æ®åº“ï¼ˆSupabase è‡ªåŠ¨å¤‡ä»½ï¼Œä½†å»ºè®®å®šæœŸå¯¼å‡ºé‡è¦æ•°æ®ï¼‰
- ç›‘æ§æ•°æ®åº“æ€§èƒ½å’Œä½¿ç”¨é‡
- åˆç†è®¾ç½® RLS ç­–ç•¥ï¼Œä¿æŠ¤ç”¨æˆ·éšç§
- åœ¨å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒçš„ Supabase é¡¹ç›®

---

**é…ç½®å®Œæˆï¼ç°åœ¨ä½ å¯ä»¥å¼€å§‹å¼€å‘è¯´å”±ä¸“è¾‘è®ºå›ç½‘ç«™äº†ï¼** ğŸ‰

