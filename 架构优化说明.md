# 项目架构优化说明

根据cursorrules的要求，对项目架构进行了全面优化和完善。

## 📋 优化内容

### 1. 网络请求规范 ✅

#### 增强的HTTP客户端 (`src/api/request.ts`)

**新增功能：**

1. **请求拦截器增强**
   - ✅ 自动添加认证token
   - ✅ 自动添加公共参数
   - ✅ 请求性能监控（记录耗时）
   - ✅ 请求缓存机制（GET请求自动缓存5分钟）
   - ✅ 请求去重（自动取消重复请求）

2. **响应拦截器增强**
   - ✅ 统一错误码处理
   - ✅ 请求重试机制（网络错误自动重试2次）
   - ✅ 性能监控和慢请求警告
   - ✅ 缓存管理

3. **请求方法扩展**
   ```typescript
   request.get()      // GET请求（自动缓存）
   request.post()     // POST请求
   request.put()      // PUT请求
   request.delete()   // DELETE请求
   request.upload()   // 文件上传（带进度）
   ```

4. **工具函数**
   ```typescript
   clearCache()                    // 清除所有缓存
   cancelAllRequests()             // 取消所有待处理请求
   getRequestMetrics()             // 获取性能指标
   getAverageRequestDuration()     // 获取平均请求时长
   getRequestSuccessRate()         // 获取请求成功率
   ```

**使用示例：**
```typescript
// 带性能监控的请求
const data = await request.get('/albums', { page: 1 })

// 文件上传带进度
await request.upload('/upload', file, (progress) => {
  console.log(`上传进度: ${progress}%`)
})

// 查看性能指标
console.log('平均请求时长:', getAverageRequestDuration())
console.log('请求成功率:', getRequestSuccessRate())
```

---

### 2. 组件封装规范 ✅

#### 创建的组件示例

##### 通用组件 (`src/components/common/`)

**BaseButton.vue** - 基础按钮组件
- ✅ 遵循单一职责原则
- ✅ 完整的TypeScript类型定义
- ✅ Props传递数据
- ✅ Emits事件通信
- ✅ 支持插槽扩展
- ✅ 完整的组件文档
- ✅ 支持多种类型和尺寸
- ✅ 加载状态和禁用状态

```vue
<BaseButton type="primary" :loading="loading" @click="submit">
  <template #icon><el-icon><Check /></el-icon></template>
  提交
</BaseButton>
```

##### 业务组件 (`src/components/business/`)

**AlbumCard.vue** - 专辑卡片组件
- ✅ 业务逻辑封装
- ✅ Props定义完整
- ✅ 事件emit清晰
- ✅ 多个插槽支持（overlay、badge、extra）
- ✅ 图片加载失败处理
- ✅ 悬停效果
- ✅ 响应式设计

```vue
<AlbumCard :album="data" @click="goToDetail">
  <template #badge><span>🔥</span></template>
  <template #extra><div>收藏: 1000</div></template>
</AlbumCard>
```

#### 组件开发规范

1. **命名规范**
   - 组件名：PascalCase（如AlbumCard）
   - Props：camelCase（如showRating）
   - Events：kebab-case（如album-click）

2. **文件结构**
   ```
   components/
   ├── common/          # 通用基础组件
   │   ├── BaseButton.vue
   │   └── README.md    # 组件文档
   └── business/        # 业务组件
       ├── AlbumCard.vue
       └── README.md
   ```

3. **类型定义**
   ```typescript
   interface Props {
     /** 完整的JSDoc注释 */
     album: Album
   }
   
   interface Emits {
     /** 点击事件 */
     (e: 'click', id: string): void
   }
   ```

---

### 3. 组合式函数 (Composables) ✅

#### 新增的Composables (`src/composables/`)

##### useRequest
通用请求Hook，自动管理loading和错误状态
```typescript
const { data, loading, error, execute } = useRequest(getAlbumList)
await execute({ page: 1 })
```

##### usePagination
分页请求Hook
```typescript
const { list, page, total, load, changePage } = usePagination(getAlbumList)
await load()  // 加载第一页
changePage(2) // 切换到第2页
```

##### useDebounce / useSearch
防抖和搜索Hook
```typescript
const { keyword, results, search } = useSearch(searchAlbums, 500)
search('说唱') // 自动防抖搜索
```

##### useDialog
对话框管理Hook
```typescript
const { visible, open, close } = useDialog()
open()  // 打开对话框
close() // 关闭对话框
```

##### useClipboard
剪贴板操作Hook
```typescript
const { copy, copied } = useClipboard()
await copy('复制的文本')
console.log(copied.value) // true
```

**优势：**
- ✅ 逻辑复用
- ✅ 代码组织清晰
- ✅ 类型安全
- ✅ 易于测试

---

### 4. 项目结构优化 ✅

#### 新的目录结构

```
src/
├── api/              # API接口层（已优化）
│   ├── request.ts    # ✨ 增强的HTTP客户端
│   ├── user.ts
│   ├── album.ts
│   └── forum.ts
│
├── composables/      # ✨ 新增：组合式函数
│   ├── useRequest.ts
│   ├── useDebounce.ts
│   ├── useDialog.ts
│   ├── useClipboard.ts
│   └── index.ts
│
├── components/       # ✨ 新增：公共组件
│   ├── common/       # 通用组件
│   │   ├── BaseButton.vue
│   │   └── README.md
│   └── business/     # 业务组件
│       ├── AlbumCard.vue
│       └── README.md
│
├── stores/           # 状态管理
├── types/            # 类型定义
├── utils/            # 工具函数
├── views/            # 页面组件
├── router/           # 路由配置
└── assets/           # 静态资源
```

---

## 🎯 优化效果

### 1. 网络请求层面
- ✅ **性能提升**：请求缓存减少重复请求
- ✅ **用户体验**：自动重试提高成功率
- ✅ **可监控性**：完整的性能指标
- ✅ **安全性**：统一的token管理
- ✅ **可维护性**：请求自动取消避免内存泄漏

### 2. 组件层面
- ✅ **可复用性**：通用组件可在多处使用
- ✅ **可维护性**：清晰的Props和Emits定义
- ✅ **可扩展性**：插槽机制提供灵活性
- ✅ **类型安全**：完整的TypeScript类型
- ✅ **文档完善**：每个组件都有使用说明

### 3. 代码组织
- ✅ **逻辑复用**：Composables避免代码重复
- ✅ **关注点分离**：业务逻辑和UI分离
- ✅ **易于测试**：纯函数便于单元测试
- ✅ **开发效率**：常用功能开箱即用

---

## 📝 最佳实践

### 1. 使用请求Hook简化组件

**优化前：**
```vue
<script setup>
const loading = ref(false)
const error = ref(null)
const albums = ref([])

async function loadAlbums() {
  loading.value = true
  try {
    albums.value = await getAlbumList()
  } catch (err) {
    error.value = err
  } finally {
    loading.value = false
  }
}
</script>
```

**优化后：**
```vue
<script setup>
const { data: albums, loading, error, execute } = useRequest(getAlbumList)
execute()
</script>
```

### 2. 使用组件封装减少重复代码

**优化前：**
```vue
<template>
  <div class="album-card">
    <img :src="album.coverUrl" />
    <h4>{{ album.title }}</h4>
    <p>{{ album.artist }}</p>
    <!-- 大量重复的HTML和样式 -->
  </div>
</template>
```

**优化后：**
```vue
<template>
  <AlbumCard :album="album" @click="handleClick" />
</template>
```

### 3. 使用Composables提取逻辑

**优化前：**
```vue
<script setup>
// 每个组件都要写一遍防抖逻辑
let timer
function search(keyword) {
  clearTimeout(timer)
  timer = setTimeout(() => {
    // 搜索逻辑
  }, 500)
}
</script>
```

**优化后：**
```vue
<script setup>
const { search, results } = useSearch(searchAlbums)
</script>
```

---

## 🔄 组件卸载时的清理

所有请求会在组件卸载时自动取消，避免内存泄漏：

```typescript
// useRequest 自动处理
const { execute } = useRequest(fetchData, {
  autoCancelOnUnmount: true // 默认为true
})

// 手动取消所有请求
import { cancelAllRequests } from '@/api/request'
onUnmounted(() => {
  cancelAllRequests()
})
```

---

## 📊 性能监控

查看请求性能数据：

```typescript
import { 
  getRequestMetrics,
  getAverageRequestDuration,
  getRequestSuccessRate 
} from '@/api/request'

// 获取所有请求记录
const metrics = getRequestMetrics()

// 平均请求时长
console.log('平均时长:', getAverageRequestDuration(), 'ms')

// 请求成功率
console.log('成功率:', getRequestSuccessRate(), '%')
```

---

## 🚀 使用建议

### 开发新功能时

1. **先查看是否有可复用的组件**
   - 查看 `components/common/README.md`
   - 查看 `components/business/README.md`

2. **优先使用Composables**
   - 请求相关：useRequest、usePagination
   - 搜索相关：useSearch、useDebounce
   - UI相关：useDialog、useClipboard

3. **新建组件遵循规范**
   - 定义完整的Props和Emits类型
   - 添加JSDoc文档注释
   - 提供使用示例
   - 考虑插槽扩展性

### 性能优化建议

1. **利用请求缓存**
   - GET请求自动缓存5分钟
   - 减少不必要的网络请求

2. **避免重复请求**
   - 自动取消重复的pending请求
   - 防抖处理用户输入

3. **组件懒加载**
   - 使用动态import
   - 路由已配置懒加载

---

## 📚 相关文档

- [开发指南.md](./开发指南.md) - 详细的开发规范
- [README.md](./README.md) - 项目说明
- [components/common/README.md](./src/components/common/README.md) - 通用组件文档
- [components/business/README.md](./src/components/business/README.md) - 业务组件文档

---

## ✅ 符合cursorrules的要求

### 网络请求规范
- ✅ 使用统一的HTTP客户端（axios）
- ✅ 实现请求拦截器，自动添加认证token和公共参数
- ✅ 实现响应拦截器，统一处理错误码和异常情况
- ✅ 所有API请求使用TypeScript接口定义
- ✅ 实现请求重试机制
- ✅ 使用环境变量管理API端点
- ✅ 实现请求取消功能，避免内存泄漏
- ✅ 实现请求缓存机制
- ✅ 监控请求性能，记录请求耗时和成功率

### 组件封装规范
- ✅ 遵循单一职责原则
- ✅ 使用Props进行数据传递
- ✅ 使用Emits进行事件通信
- ✅ 实现插槽(Slot)机制
- ✅ 为组件提供完整的TypeScript类型定义
- ✅ 实现组件文档，包括Props、Emits、Slots说明
- ✅ 遵循命名规范
- ✅ 为组件提供默认样式和主题定制能力

---

**架构优化完成！现在项目具备了企业级的代码质量和开发体验！** 🎉

